angular.module("artJoystick",[]),angular.module("artJoystick").factory("artJoystickExternal",function(){return{}}).factory("artDifferentialControl",function(){var a=function(a,b,c){return a===a&&(void 0!==c&&(a=c>=a?a:c),void 0!==b&&(a=a>=b?a:b)),a},b=function(b,c,d){return void 0===d&&(d=c,c=void 0),void 0!==d&&(d=parseFloat(d),d=d===d?d:0),void 0!==c&&(c=parseFloat(c),c=c===c?c:0),a(parseFloat(b),c,d)},c=function d(a,c,e,f,g,h){var i,j=0,k=0,l=0,m=0,n=0,o=0,p=0;return"undefined"==typeof h&&(h=d.axisFlip),"undefined"==typeof e&&(e=d.maxAxis),"undefined"==typeof f&&(f=d.minAxis),"undefined"==typeof g&&(g=d.maxSpeed),j=a/e,m=c*(1+j),m=b(m,f,e),p=c*(1-j),p=b(p,f,e),i=1-Math.abs(c/e),k=-a*i,n=a*i,l=(m+k)*h,l=b(l,f,e),o=(p+n)*h,o=b(o,f,e),[g*l,g*o]};return c.axisFlip=-1,c.maxAxis=1,c.maxSpeed=255,c.minAxis=-1,{calculate:function(a,b,d,e,f,g){return c(a,b,d,e,f,g)}}}).directive("artJoystick",["$parse","$document","$timeout","$compile","artJoystickExternal","artDifferentialControl",function(a,b,c,d,e,f){return{restrict:"E",scope:{sendMovement:"&",cordovaEnabled:"=",vibrationEnabled:"=",speedIncrease:"=",maxPositiveSpeed:"=",maxNegativeSpeed:"=",directionManagement:"=",controlSize:"=",speedDebug:"="},transclude:!1,templateUrl:"angular-joystick.html",controller:function(a,b,c){c.goBackToLevel=function(a){console.log("direction",a)}},link:function(a,b,d){function e(b){h.moving&&(a.actual.x=g[0].offsetLeft,a.actual.y=g[0].offsetTop,s(a.actual.x,a.actual.y)),h.singleButton&&v(h.singleButton,b),window.requestAnimationFrame(e)}var g=angular.element(b[0].querySelector(".art-joystick")),h=(b[0].querySelector(".art-pad"),{center:[g[0].offsetLeft,g[0].offsetTop],moving:0,directiveOffset:[b[0].offsetLeft,b[0].offsetTop],touchedCenter:[],elementPosition:b[0].getBoundingClientRect(),cordova:function(){return a.cordovaEnabled?!0:!1},debug:function(){return a.speedDebug?!0:!1},vibrationEnabled:function(){return a.vibrationEnabled?!0:!1},speedIncrease:function(){return"exponential"===a.speedIncrease?"exponential":"linear"},maxPositiveSpeed:a.maxPositiveSpeed||255,maxNegativeSpeed:a.maxNegativeSpeed||-255,directionManagement:function(){return"angle"===a.directionManagement?"angle":"directions"===a.directionManagement?"directions":"differential"},controlSize:function(){return a.controlSize&&parseInt(a.controlSize)?parseInt(a.controlSize):!1},pixelToSpeedRatio:0,radius:0,timeoutToStop:700,singleButton:!1});a.debug=h.debug(),a.actual={x:0,y:0,speed:0,arrows:{up:0,down:0,left:0,right:0},finalWheelSpeedLeft:0,finalWheelSpeedRight:0},h.controlSize()&&angular.element(b.children()).css({width:h.controlSize()+"px",height:h.controlSize()+"px"}),c(function(){h.center=[g[0].offsetLeft,g[0].offsetTop],g.css({left:h.center[0]+"px"}),g.css({top:h.center[1]+"px"})},500);var i=0,j=0,k=function(a){var b=a[j][0];o(b.clientX,b.clientY)};g.on("touchstart",function(a){h.moving=1,c.cancel(i);var b=[];a.originalEvent?(b=a.originalEvent.touches[0]||a.originalEvent.changedTouches[0],j="originalEvent"):a.targetTouches?(b=a.targetTouches[0],j="targetTouches"):a.changedTouches&&(b=a.changedTouches[0],j="changedTouches"),h.touchedCenter=[b.clientX,b.clientY],angular.element(window).on("touchmove",k)}),angular.element(window).on("touchend",function(a){i=c(function(){h.moving=0},h.timeoutToStop),p(g),angular.element(window).off("touchmove",k)});var l=function(a){o(a.clientX,a.clientY)};g.on("mousedown",function(a){h.moving=1,c.cancel(i),h.touchedCenter=[a.clientX,a.clientY],angular.element(window).on("mousemove",l)}),angular.element(window).on("mouseup",function(a){i=c(function(){h.moving=0},h.timeoutToStop),p(g),angular.element(window).off("mousemove",l)}),window.requestAnimationFrame(e);var m=function(a,b,c,d,e){var f=n([a,b],[c,d]);if(e>=f)return{x:a,y:b};a-=c,b-=d;var g=Math.atan2(b,a);return{x:Math.cos(g)*e+c,y:Math.sin(g)*e+d}},n=function(a,b){var c=a[0],d=a[1],e=b[0],f=b[1];return Math.sqrt(Math.pow(c-e,2)+Math.pow(d-f,2))},o=function(b,c){var d=h.center[0],e=d,f=d,i=d-20;h.radius=i;var j=b-h.touchedCenter[0],k=c-h.touchedCenter[1],l=m(h.center[0]+j,h.center[1]+k,e,f,i);g.css({left:l.x+"px"}).css({top:l.y+"px"}),a.$apply()},p=function(a){a.addClass("returning"),c(function(){a.css({left:h.center[0]+"px",top:h.center[1]+"px"})},h.timeoutToStop-500),c(function(){a.removeClass("returning")},h.timeoutToStop)},q=function(a,b){var c=100;h.center[0]>100&&(c=1e3);var d=h.center[0],e=h.center[1];return[-(a-d)/c,-(b-e)/c]},r=function(){var a=h.radius;if("linear"===h.speedIncrease()){var b=h.maxPositiveSpeed/a;return h.pixelToSpeedRatio=b,b}console.log("Exponential")},s=function(a,b){var c=q(a,b),d=h.pixelToSpeedRatio||r();"differential"===h.directionManagement()&&w(c,d)},t=0,u=0,v=function(a,b){c.cancel(u),t||(t=b),u=c(function(){},2e3),console.log(a)},w=function(b,c){var d=f.calculate(b[0],b[1],void 0,void 0,h.maxPositiveSpeed),e=d[0];e>50?e=50+e:-50>e?e-=50:e=0;var g=d[1];g>50?g=50+g:-50>g?g-=50:g=0,a.actual.finalWheelSpeedLeft=parseInt(0-e),a.actual.finalWheelSpeedRight=parseInt(0-g),a.sendMovement({response:{left:0-e,right:0-g}})}}}}]),angular.module("artJoystick").run(["$templateCache",function(a){"use strict";a.put("angular-joystick.html",'<div class="art-joystick-container">\n    <div class="art-pad"></div>\n    <div class="art-joystick-area">\n        <div class="art-joystick">\n            <div class="art-button"></div>\n        </div>\n    </div>\n    <div class="art-arrow-up art-arrow" ng-mousedown="simpleDirection.up()"></div>\n    <div class="art-arrow-down art-arrow" ng-mousedown="simpleDirection.up()"></div>\n    <div class="art-arrow-left art-arrow" ng-mousedown="simpleDirection.up()"></div>\n    <div class="art-arrow-right art-arrow" ng-mousedown="simpleDirection.up()"></div>\n    <div ng-if="debug" class="art-debug">\n        <p><small>L:</small> {{actual.finalWheelSpeedLeft}}</p>\n        <p><small>R:</small> {{actual.finalWheelSpeedRight}}</p>\n    </div>\n</div>')}]);